#!/bin/sh
# SANDRA IA 7.0 - Pre-commit Security Hook
# Prevents accidental commit of secrets

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîí Running security checks..."

# Patterns to detect secrets
SECRET_PATTERNS=(
  # API Keys
  "sk-[a-zA-Z0-9]{20,}"
  "sk-proj-[a-zA-Z0-9]{40,}"
  "sk-ant-[a-zA-Z0-9]{40,}"
  "gsk_[a-zA-Z0-9]{40,}"
  "sk_car_[a-zA-Z0-9]{20,}"
  "nfp_[a-zA-Z0-9]{40,}"

  # Generic patterns
  "api[_-]?key.*=.*['"][a-zA-Z0-9]{32,}['"]"
  "secret.*=.*['"][a-zA-Z0-9]{32,}['"]"
  "token.*=.*['"][a-zA-Z0-9]{32,}['"]"
  "password.*=.*['"][^'"]{8,}['"]"

  # AWS
  "AKIA[0-9A-Z]{16}"

  # Private keys
  "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----"
)

# Check staged files for secrets
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úì No files staged for commit"
  exit 0
fi

FOUND_SECRETS=false

for pattern in "${SECRET_PATTERNS[@]}"; do
  for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
      if grep -qE "$pattern" "$file"; then
        echo "${RED}‚ö†Ô∏è  WARNING: Potential secret found in $file${NC}"
        echo "   Pattern: $pattern"
        FOUND_SECRETS=true
      fi
    fi
  done
done

# Check for .env files
for file in $STAGED_FILES; do
  if [[ "$file" == *.env* ]] && [[ "$file" != *.example* ]] && [[ "$file" != *.template* ]]; then
    echo "${RED}‚ùå ERROR: Attempting to commit .env file: $file${NC}"
    echo "   .env files should never be committed!"
    FOUND_SECRETS=true
  fi
done

if [ "$FOUND_SECRETS" = true ]; then
  echo ""
  echo "${RED}‚ùå Commit blocked: Potential secrets detected!${NC}"
  echo ""
  echo "Options:"
  echo "1. Remove the sensitive data from your files"
  echo "2. Add the file to .gitignore if it contains secrets"
  echo "3. Use environment variables instead of hardcoded values"
  echo "4. If this is a false positive, use: git commit --no-verify"
  echo ""
  exit 1
fi

echo "${GREEN}‚úì Security check passed - no secrets detected${NC}"
exit 0
