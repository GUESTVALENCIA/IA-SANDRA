<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.groq.com https://api.deepgram.com https://api.heygen.com https://api.cartesia.ai https://*.neon.tech wss://*.heygen.com; font-src 'self'; media-src 'self' blob:; worker-src 'none'; child-src 'none';">
  <script>
    // Bloquear Service Workers explÃ­citamente
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
          console.log('ğŸš« Service Worker desregistrado:', registration.scope);
        }
      });
    }
  </script>
  <title>Sandra IA 8.0 Pro - Multimodal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      overflow: hidden;
      height: 100vh;
    }

    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr 350px;
      grid-template-rows: 60px calc(100vh - 140px) 80px;
      height: 100vh;
      gap: 0;
      overflow: hidden;
    }

    /* HEADER */
    .header {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 0 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 100;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .ai-provider {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-provider:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .provider-selector {
      position: absolute;
      top: 65px;
      right: 30px;
      background: #16213e;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 12px;
      min-width: 220px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 1000;
      display: none;
    }

    .provider-selector.active {
      display: block;
    }

    .provider-option {
      padding: 12px 16px;
      margin: 4px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }

    .provider-option:hover {
      background: rgba(102, 126, 234, 0.2);
    }

    .provider-option.active {
      background: rgba(102, 126, 234, 0.4);
      border: 1px solid rgba(102, 126, 234, 0.6);
    }

    .provider-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .provider-status {
      font-size: 12px;
      opacity: 0.7;
    }

    /* SIDEBAR */
    .sidebar {
      background: #16213e;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar::-webkit-scrollbar { width: 6px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    .sidebar h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8b92a8;
      margin: 20px 0 10px 0;
    }

    .sidebar h3:first-child { margin-top: 0; }

    .role-category {
      margin-bottom: 25px;
    }

    .role-category h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8b92a8;
      margin: 20px 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .role-btn {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .role-btn:hover {
      background: rgba(102, 126, 234, 0.3);
      border-color: #667eea;
      transform: translateX(5px);
    }

    .role-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
    }

    .role-btn.hidden {
      display: none;
    }

    /* CHAT AREA */
    .chat-area {
      display: flex;
      flex-direction: column;
      background: #0f3460;
      position: relative;
      overflow: hidden;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      scroll-behavior: smooth;
    }

    .messages-container::-webkit-scrollbar { width: 8px; }
    .messages-container::-webkit-scrollbar-track { background: transparent; }
    .messages-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    .message {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .message-content {
      max-width: 70%;
      padding: 15px 20px;
      border-radius: 18px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      line-height: 1.6;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message-time {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-top: 5px;
    }

    /* QUICK ACTIONS */
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .quick-action-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
      border: 2px solid rgba(102, 126, 234, 0.5);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      backdrop-filter: blur(10px);
    }

    .quick-action-btn:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.5) 0%, rgba(118, 75, 162, 0.5) 100%);
      border-color: rgba(102, 126, 234, 0.8);
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .quick-action-btn:active {
      transform: translateX(3px) scale(0.98);
    }

    .welcome-message {
      animation: welcomeSlideIn 0.5s ease-out;
    }

    @keyframes welcomeSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* AVATAR PANEL */
    .avatar-panel {
      background: #16213e;
      padding: 20px;
      border-left: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .avatar-container {
      width: 100%;
      aspect-ratio: 1;
      background: #0f3460;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    #heygen-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-status {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      font-size: 12px;
    }

    .avatar-status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .avatar-status-item:last-child { margin-bottom: 0; }

    .status-label {
      color: rgba(255,255,255,0.6);
    }

    .status-value {
      font-weight: 600;
      color: #10b981;
    }

    /* MULTIMODAL INPUT BAR */
    .input-bar {
      grid-column: 1 / -1;
      grid-row: 3;
      background: #16213e;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 15px 30px;
      display: flex !important;
      gap: 15px;
      align-items: center;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
      position: relative;
      z-index: 100;
      min-height: 80px;
      height: 80px;
      max-height: 80px;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #message-input {
      flex: 1;
      padding: 15px 20px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 25px;
      color: #fff;
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
    }

    #message-input:focus {
      border-color: #667eea;
      background: rgba(255,255,255,0.08);
    }

    .input-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .btn-video {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
    }

    .btn-video:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(245, 158, 11, 0.5);
    }

    .btn-video.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      animation: videoPulse 2s infinite;
    }

    @keyframes videoPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    }

    .btn-voice {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .btn-voice:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-voice.recording {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      animation: recordPulse 1.5s infinite;
    }

    @keyframes recordPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .btn-send {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
    }

    .btn-send:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(16, 185, 129, 0.5);
    }

    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: scale(1);
    }

    /* RECORDING INDICATOR */
    .recording-indicator {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      padding: 12px 24px;
      border-radius: 25px;
      display: none;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      box-shadow: 0 5px 20px rgba(239, 68, 68, 0.5);
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-10px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .recording-indicator.active {
      display: flex;
    }

    .recording-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fff;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* LOADING */
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.6);
    }

    .loading.active {
      display: block;
    }

    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* TOAST NOTIFICATIONS */
    .toast {
      position: fixed;
      top: 80px;
      right: 30px;
      background: rgba(16, 185, 129, 0.95);
      color: #fff;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.active {
      display: flex;
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.95);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- HEADER -->
    <div class="header">
      <h1>
        <span class="status-indicator"></span>
        ğŸš€ Sandra IA 8.0 Pro
      </h1>
      <div class="header-controls">
        <div class="ai-provider" id="ai-provider" onclick="toggleProviderSelector()">
          <span id="provider-name">Groq</span>
          <span>â–¼</span>
        </div>
      </div>
    </div>

    <!-- SELECTOR DE PROVEEDOR LLM -->
    <div class="provider-selector" id="provider-selector">
      <div id="provider-options">
        <!-- Se llenarÃ¡ dinÃ¡micamente -->
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <input 
          type="text" 
          id="role-search" 
          placeholder="ğŸ” Buscar rol..." 
          style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 13px; outline: none;"
        />
      </div>
      
      <div class="role-category">
        <h3>ğŸ¯ Core SOE (7)</h3>
        <button class="role-btn active" data-role="general" data-category="core">
          ğŸ’¬ General
        </button>
        <button class="role-btn" data-role="orchestrator" data-category="core">
          ğŸ¼ Orquestador
        </button>
        <button class="role-btn" data-role="product_ceo" data-category="core">
          ğŸ‘” Product CEO
        </button>
        <button class="role-btn" data-role="developer" data-category="core">
          ğŸ’» Desarrollador
        </button>
        <button class="role-btn" data-role="devops" data-category="core">
          ğŸš€ DevOps
        </button>
        <button class="role-btn" data-role="api_designer" data-category="core">
          ğŸ”Œ API Designer
        </button>
        <button class="role-btn" data-role="security" data-category="core">
          ğŸ”’ Security
        </button>
        <button class="role-btn" data-role="prompt_engineer" data-category="core">
          âœï¸ Prompt Engineer
        </button>
      </div>

      <div class="role-category">
        <h3>ğŸŒŸ Sandra IA 7.0 (18)</h3>
        <button class="role-btn" data-role="concierge" data-category="sandra">
          ğŸ¨ Concierge
        </button>
        <button class="role-btn" data-role="owner_acquisition" data-category="sandra">
          ğŸ  Owner Acquisition
        </button>
        <button class="role-btn" data-role="community_manager" data-category="sandra">
          ğŸ‘¥ Community Manager
        </button>
        <button class="role-btn" data-role="youtuber" data-category="sandra">
          ğŸ¬ YouTuber
        </button>
        <button class="role-btn" data-role="tourism" data-category="sandra">
          âœˆï¸ Turismo
        </button>
        <button class="role-btn" data-role="sales" data-category="sandra">
          ğŸ’¼ Ventas
        </button>
        <button class="role-btn" data-role="analyst" data-category="sandra">
          ğŸ“Š Analista
        </button>
        <button class="role-btn" data-role="marketing" data-category="sandra">
          ğŸ“ˆ Marketing
        </button>
        <button class="role-btn" data-role="ceo" data-category="sandra">
          ğŸ¢ CEO/Ejecutivo
        </button>
        <button class="role-btn" data-role="designer" data-category="sandra">
          ğŸ¨ DiseÃ±ador
        </button>
        <button class="role-btn" data-role="lawyer" data-category="sandra">
          âš–ï¸ Abogado
        </button>
        <button class="role-btn" data-role="financial" data-category="sandra">
          ğŸ’° Financiero
        </button>
        <button class="role-btn" data-role="psychologist" data-category="sandra">
          ğŸ§  PsicÃ³logo
        </button>
        <button class="role-btn" data-role="teacher" data-category="sandra">
          ğŸ“š Profesor
        </button>
        <button class="role-btn" data-role="artist" data-category="sandra">
          ğŸ­ Artista
        </button>
        <button class="role-btn" data-role="scientist" data-category="sandra">
          ğŸ”¬ CientÃ­fico
        </button>
        <button class="role-btn" data-role="engineer" data-category="sandra">
          ğŸ”§ Ingeniero
        </button>
        <button class="role-btn" data-role="doctor" data-category="sandra">
          ğŸ¥¼ MÃ©dico
        </button>
      </div>

      <div class="role-category">
        <h3>ğŸš€ Especializados (27)</h3>
        <button class="role-btn" data-role="influencer_marketing" data-category="specialized">
          ğŸ“± Influencer Marketing
        </button>
        <button class="role-btn" data-role="cryptocurrency" data-category="specialized">
          â‚¿ Cryptocurrency
        </button>
        <button class="role-btn" data-role="viralization" data-category="specialized">
          ğŸ”¥ ViralizaciÃ³n
        </button>
        <button class="role-btn" data-role="optimization" data-category="specialized">
          âš¡ OptimizaciÃ³n
        </button>
        <button class="role-btn" data-role="ui_ux" data-category="specialized">
          ğŸ¨ UI/UX
        </button>
        <button class="role-btn" data-role="finance" data-category="specialized">
          ğŸ’µ Finanzas
        </button>
        <button class="role-btn" data-role="yoga" data-category="specialized">
          ğŸ§˜ Yoga
        </button>
        <button class="role-btn" data-role="mindfulness" data-category="specialized">
          ğŸ§  Mindfulness
        </button>
        <button class="role-btn" data-role="sexology" data-category="specialized">
          ğŸ’• SexologÃ­a
        </button>
        <button class="role-btn" data-role="content_creator" data-category="specialized">
          âœï¸ Content Creator
        </button>
        <button class="role-btn" data-role="animation" data-category="specialized">
          ğŸ¬ AnimaciÃ³n
        </button>
        <button class="role-btn" data-role="language_teacher" data-category="specialized">
          ğŸŒ Language Teacher
        </button>
        <button class="role-btn" data-role="empathy" data-category="specialized">
          â¤ï¸ EmpatÃ­a
        </button>
        <button class="role-btn" data-role="geography" data-category="specialized">
          ğŸŒ GeografÃ­a
        </button>
        <button class="role-btn" data-role="startup_visionary" data-category="specialized">
          ğŸš€ Startup Visionary
        </button>
        <button class="role-btn" data-role="general_knowledge" data-category="specialized">
          ğŸ“š Conocimiento General
        </button>
        <button class="role-btn" data-role="self_development" data-category="specialized">
          ğŸŒ± Auto-desarrollo
        </button>
        <button class="role-btn" data-role="project_analyst" data-category="specialized">
          ğŸ“Š Project Analyst
        </button>
        <button class="role-btn" data-role="social_media" data-category="specialized">
          ğŸ“± Social Media
        </button>
        <button class="role-btn" data-role="dev_support" data-category="specialized">
          ğŸ’» Dev Support
        </button>
        <button class="role-btn" data-role="logistics" data-category="specialized">
          ğŸ“¦ LogÃ­stica
        </button>
        <button class="role-btn" data-role="organization" data-category="specialized">
          ğŸ“‹ OrganizaciÃ³n
        </button>
        <button class="role-btn" data-role="ai_expert" data-category="specialized">
          ğŸ¤– AI Expert
        </button>
      </div>

      <div class="role-category">
        <h3>ğŸ“Š Marketing (10)</h3>
        <button class="role-btn" data-role="business_analyst" data-category="marketing">
          ğŸ“ˆ Business Analyst
        </button>
        <button class="role-btn" data-role="marketing_strategist" data-category="marketing">
          ğŸ¯ Marketing Strategist
        </button>
        <button class="role-btn" data-role="content_strategist" data-category="marketing">
          âœï¸ Content Strategist
        </button>
        <button class="role-btn" data-role="social_media_manager" data-category="marketing">
          ğŸ“± Social Media Manager
        </button>
        <button class="role-btn" data-role="seo_specialist" data-category="marketing">
          ğŸ” SEO Specialist
        </button>
        <button class="role-btn" data-role="ppc_specialist" data-category="marketing">
          ğŸ’° PPC Specialist
        </button>
        <button class="role-btn" data-role="email_marketer" data-category="marketing">
          ğŸ“§ Email Marketer
        </button>
        <button class="role-btn" data-role="brand_manager" data-category="marketing">
          ğŸ·ï¸ Brand Manager
        </button>
        <button class="role-btn" data-role="analytics_specialist" data-category="marketing">
          ğŸ“Š Analytics Specialist
        </button>
        <button class="role-btn" data-role="growth_hacker" data-category="marketing">
          ğŸš€ Growth Hacker
        </button>
      </div>

      <h3>âš™ï¸ Sistema</h3>
      <button class="role-btn" data-action="mcp">
        ğŸ› ï¸ Panel MCP
      </button>
      <button class="role-btn" data-action="validate">
        âœ… Validar Roles
      </button>
      <button class="role-btn" data-action="stats">
        ğŸ“Š EstadÃ­sticas
      </button>
      <button class="role-btn" data-action="clear">
        ğŸ§¹ Limpiar Chat
      </button>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area">
      <div class="messages-container" id="messages">
        <div class="message assistant welcome-message">
          <div class="message-avatar">S</div>
          <div class="message-content">
            <div>
              <strong>Â¡Hola! ğŸ‘‹ Soy Sandra IA 8.0 Pro</strong><br>
              <p style="margin: 10px 0; opacity: 0.9;">Asistente multimodal premium con <strong>62 roles especializados</strong> listos para ayudarte.</p>
              
              <div class="quick-actions" style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                <button class="quick-action-btn" onclick="executeQuickAction('system-status')">
                  ğŸš€ Verificar estado del sistema
                </button>
                <button class="quick-action-btn" onclick="executeQuickAction('test-multimodal')">
                  ğŸ¤ Probar chat multimodal
                </button>
                <button class="quick-action-btn" onclick="executeQuickAction('github-sync')">
                  ğŸ”„ Sincronizar con GitHub
                </button>
              </div>
              
              <p style="margin-top: 15px; font-size: 13px; opacity: 0.7;">O simplemente escribe o habla para comenzar una conversaciÃ³n.</p>
            </div>
            <div class="message-time" id="init-time"></div>
          </div>
        </div>
      </div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Sandra estÃ¡ pensando...</div>
      </div>
    </div>

    <!-- AVATAR PANEL -->
    <div class="avatar-panel">
      <div class="avatar-container">
        <video id="heygen-avatar-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
        <div id="heygen-avatar"></div>
      </div>
      
      <!-- Selector de Voz -->
      <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
        <label style="font-size: 11px; color: rgba(255,255,255,0.6); display: block; margin-bottom: 5px;">ğŸ™ï¸ Voz del Avatar:</label>
        <select id="voice-selector" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #fff; font-size: 12px;">
          <option value="default">Sandra (EspaÃ±ol)</option>
          <option value="voice-2">MarÃ­a (Formal)</option>
          <option value="voice-3">Carmen (Amigable)</option>
          <option value="voice-4">Laura (Profesional)</option>
        </select>
      </div>

      <!-- Modo ConversaciÃ³n -->
      <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="continuous-mode" style="width: 16px; height: 16px;">
          <span style="font-size: 12px; color: #fff;">ğŸ”„ Modo Continuo</span>
        </label>
        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 5px; margin-left: 24px;">
          ConversaciÃ³n sin clicks
        </div>
      </div>

      <!-- Barge-in -->
      <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="barge-in-toggle" checked style="width: 16px; height: 16px;">
          <span style="font-size: 12px; color: #fff;">âš¡ Barge-in</span>
        </label>
        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 5px; margin-left: 24px;">
          Interrumpir respuestas
        </div>
      </div>

      <div class="avatar-status">
        <div class="avatar-status-item">
          <span class="status-label">Estado:</span>
          <span class="status-value" id="avatar-status">Conectado</span>
        </div>
        <div class="avatar-status-item">
          <span class="status-label">Rol Activo:</span>
          <span class="status-value" id="active-role">General</span>
        </div>
        <div class="avatar-status-item">
          <span class="status-label">Modo:</span>
          <span class="status-value" id="mode-status">Multimodal</span>
        </div>
      </div>
    </div>

    <!-- MULTIMODAL INPUT BAR -->
    <div class="input-bar">
      <div class="recording-indicator" id="recording-indicator">
        <div class="recording-dot"></div>
        <span>Grabando... (Click para detener)</span>
      </div>
      
      <!-- Audio Visualizer Canvas -->
      <canvas id="audio-visualizer" style="position: absolute; top: -60px; left: 50%; transform: translateX(-50%); width: 400px; height: 50px; border-radius: 8px; background: rgba(0,0,0,0.3); display: none;"></canvas>
      
      <div class="input-wrapper">
        <input 
          type="text" 
          id="message-input" 
          placeholder="Escribe tu mensaje, usa el micrÃ³fono o inicia videollamada..."
          autocomplete="off"
        />
        <button class="input-btn btn-video" id="video-btn" title="Iniciar videollamada con avatar">
          ğŸ“¹
        </button>
        <button class="input-btn btn-voice" id="voice-btn" title="Grabar voz">
          ğŸ¤
        </button>
        <button class="input-btn btn-send" id="send-btn" title="Enviar mensaje">
          â¤
        </button>
      </div>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div class="toast" id="toast">
    <span id="toast-message"></span>
  </div>

  <!-- MCP PANEL (MODULAR CONTROL PANEL) -->
  <div id="mcp-panel" style="display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 900px; max-height: 80vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #667eea; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden;">
    <!-- MCP Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
      <h2 style="font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
        ğŸ› ï¸ MCP - Modular Control Panel
      </h2>
      <button id="mcp-close" style="background: rgba(255,255,255,0.2); border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">Ã—</button>
    </div>
    
    <!-- MCP Content -->
    <div style="padding: 20px; overflow-y: auto; max-height: calc(80vh - 60px);">
      <!-- Tabs -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
        <button class="mcp-tab active" data-tab="code" style="padding: 8px 16px; background: rgba(102, 126, 234, 0.3); border: 1px solid #667eea; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ’» Generar CÃ³digo</button>
        <button class="mcp-tab" data-tab="deploy" style="padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸš€ Deploy</button>
        <button class="mcp-tab" data-tab="agents" style="padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ¤– Agentes</button>
        <button class="mcp-tab" data-tab="github" style="padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 600;">ğŸ“¦ GitHub</button>
      </div>
      
      <!-- Tab: Generar CÃ³digo -->
      <div id="mcp-tab-code" class="mcp-tab-content">
        <h3 style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 15px;">GeneraciÃ³n de CÃ³digo con IA</h3>
        
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">Tarea:</label>
        <textarea id="mcp-code-task" placeholder="Ej: Crear una funciÃ³n para validar emails..." style="width: 100%; height: 100px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px; resize: vertical; margin-bottom: 15px;"></textarea>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">Rol:</label>
            <select id="mcp-code-role" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
              <option value="developer">ğŸ’» Desarrollador</option>
              <option value="engineer">ğŸ”§ Ingeniero</option>
              <option value="scientist">ğŸ”¬ CientÃ­fico</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">Lenguaje:</label>
            <select id="mcp-code-lang" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
              <option value="javascript">JavaScript</option>
              <option value="python">Python</option>
              <option value="typescript">TypeScript</option>
              <option value="java">Java</option>
              <option value="csharp">C#</option>
            </select>
          </div>
        </div>
        
        <button id="mcp-generate-code" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 6px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">âœ¨ Generar CÃ³digo</button>
        
        <div id="mcp-code-output" style="display: none;">
          <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">CÃ³digo Generado:</label>
          <pre style="background: #0f3460; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; color: #10b981; max-height: 300px; overflow-y: auto;"><code id="mcp-code-result"></code></pre>
        </div>
      </div>
      
      <!-- Tab: Deploy -->
      <div id="mcp-tab-deploy" class="mcp-tab-content" style="display: none;">
        <h3 style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 15px;">Despliegue AutomÃ¡tico</h3>
        
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">Nombre del Proyecto:</label>
        <input id="mcp-deploy-name" type="text" placeholder="mi-proyecto" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px; margin-bottom: 15px;">
        
        <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">URL del Repositorio:</label>
        <input id="mcp-deploy-repo" type="text" placeholder="https://github.com/user/repo.git" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px; margin-bottom: 15px;">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">Proveedor:</label>
            <select id="mcp-deploy-provider" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
              <option value="vercel">Vercel</option>
              <option value="netlify">Netlify</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">Entorno:</label>
            <select id="mcp-deploy-env" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
              <option value="production">Production</option>
              <option value="staging">Staging</option>
            </select>
          </div>
        </div>
        
        <button id="mcp-deploy-btn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">ğŸš€ Desplegar Ahora</button>
        
        <div id="mcp-deploy-output" style="display: none; margin-top: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 6px; font-size: 12px; color: #10b981;"></div>
      </div>
      
      <!-- Tab: Agentes -->
      <div id="mcp-tab-agents" class="mcp-tab-content" style="display: none;">
        <h3 style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 15px;">GestiÃ³n de Agentes</h3>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <select id="mcp-agent-role" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
            <option value="developer">ğŸ’» Desarrollador</option>
            <option value="youtuber">ğŸ¬ YouTuber</option>
            <option value="community">ğŸ‘¥ Community Manager</option>
            <option value="tourism">ğŸ¨ Turismo</option>
            <option value="sales">ğŸ’¼ Ventas</option>
          </select>
          <button id="mcp-spawn-agent" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;">ğŸ¤– Crear Agente</button>
        </div>
        
        <div id="mcp-agents-list" style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 15px; min-height: 200px;">
          <div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px 0;">
            No hay agentes activos
          </div>
        </div>
      </div>
      
      <!-- Tab: GitHub -->
      <div id="mcp-tab-github" class="mcp-tab-content" style="display: none;">
        <h3 style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 15px;">SincronizaciÃ³n con GitHub</h3>
        
        <button id="mcp-github-sync" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">ğŸ”„ Sincronizar Ahora</button>
        
        <div id="mcp-github-status" style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 15px;">
          <div style="text-align: center; color: rgba(255,255,255,0.4);">
            Click en sincronizar para obtener el estado del repositorio
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== VARIABLES GLOBALES ====================
    let currentRole = 'general';
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let servicesReady = false;
    let audioVisualizer = null;
    let currentVoiceId = 'default';
    let continuousMode = false;
    let bargeInEnabled = true;
    let webrtcManager = null;

    // ==================== ELEMENTOS DOM ====================
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const voiceBtn = document.getElementById('voice-btn');
    const recordingIndicator = document.getElementById('recording-indicator');
    const loading = document.getElementById('loading');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const activeRoleDisplay = document.getElementById('active-role');
    const avatarStatus = document.getElementById('avatar-status');

    // ==================== INICIALIZACIÃ“N ====================
    document.getElementById('init-time').textContent = new Date().toLocaleTimeString('es-ES');

    // Escuchar eventos del sistema
    if (window.sandraAPI) {
      window.sandraAPI.onServicesReady((data) => {
        servicesReady = true;
        showToast('âœ… Todos los servicios iniciados correctamente');
        avatarStatus.textContent = 'Operativo';
      });

      window.sandraAPI.onServicesError((data) => {
        showToast('âŒ Error: ' + data.error, 'error');
        avatarStatus.textContent = 'Error';
      });

      // Cargar proveedores LLM disponibles
      loadAvailableProviders();
    }

    // ==================== SELECTOR DE PROVEEDOR LLM ====================
    let currentProvider = 'groq';

    async function loadAvailableProviders() {
      try {
        const result = await window.sandraAPI.getAvailableProviders();
        if (result.success) {
          renderProviderOptions(result.providers);
          
          // Obtener proveedor actual
          const currentResult = await window.sandraAPI.getCurrentProvider();
          if (currentResult.success) {
            currentProvider = currentResult.provider.name;
            updateProviderDisplay(currentProvider);
          }
        }
      } catch (error) {
        console.error('Error cargando proveedores:', error);
      }
    }

    function renderProviderOptions(providers) {
      const container = document.getElementById('provider-options');
      container.innerHTML = '';
      
      providers.forEach(provider => {
        const option = document.createElement('div');
        option.className = `provider-option ${provider.id === currentProvider ? 'active' : ''} ${!provider.hasApiKey ? 'disabled' : ''}`;
        
        let statusText = provider.hasApiKey ? 'âœ… Configurado' : 'âš ï¸ Sin API Key';
        if (provider.note) {
          statusText = `${provider.hasApiKey ? 'âœ…' : 'âš ï¸'} ${provider.note}`;
        }
        
        option.innerHTML = `
          <div>
            <div style="font-weight: 600;">${provider.name} ${provider.id === currentProvider ? '(Activo)' : ''}</div>
            <div class="provider-status">${statusText}</div>
            ${provider.defaultModel ? `<div class="provider-status" style="opacity: 0.5; font-size: 11px;">Modelo: ${provider.defaultModel}</div>` : ''}
          </div>
        `;
        
        if (provider.hasApiKey) {
          option.onclick = () => switchProvider(provider.id);
        }
        
        container.appendChild(option);
      });
    }

    async function switchProvider(providerId) {
      try {
        const result = await window.sandraAPI.setProvider(providerId);
        if (result.success) {
          currentProvider = providerId;
          updateProviderDisplay(providerId);
          showToast(`âœ… Proveedor cambiado a ${providerId.toUpperCase()}`);
          
          // Recargar opciones para actualizar el activo
          loadAvailableProviders();
          
          // Cerrar selector
          document.getElementById('provider-selector').classList.remove('active');
        }
      } catch (error) {
        showToast('âŒ Error cambiando proveedor: ' + error.message, 'error');
      }
    }

    function updateProviderDisplay(providerId) {
      const providerName = providerId.charAt(0).toUpperCase() + providerId.slice(1);
      document.getElementById('provider-name').textContent = providerName;
    }

    function toggleProviderSelector() {
      const selector = document.getElementById('provider-selector');
      selector.classList.toggle('active');
    }

    // Cerrar selector al hacer click fuera
    document.addEventListener('click', (e) => {
      const selector = document.getElementById('provider-selector');
      const providerBtn = document.getElementById('ai-provider');
      
      if (!selector.contains(e.target) && !providerBtn.contains(e.target)) {
        selector.classList.remove('active');
      }
    });

    // ==================== BÃšSQUEDA DE ROLES ====================
    const roleSearch = document.getElementById('role-search');
    if (roleSearch) {
      roleSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const allRoleBtns = document.querySelectorAll('.role-btn[data-role]');
        const categories = document.querySelectorAll('.role-category');
        
        if (searchTerm === '') {
          // Mostrar todos
          allRoleBtns.forEach(btn => btn.classList.remove('hidden'));
          categories.forEach(cat => cat.style.display = 'block');
        } else {
          // Filtrar roles
          let hasVisibleRoles = false;
          allRoleBtns.forEach(btn => {
            const roleText = btn.textContent.toLowerCase();
            if (roleText.includes(searchTerm)) {
              btn.classList.remove('hidden');
              hasVisibleRoles = true;
            } else {
              btn.classList.add('hidden');
            }
          });
          
          // Ocultar categorÃ­as vacÃ­as
          categories.forEach(cat => {
            const visibleBtns = cat.querySelectorAll('.role-btn:not(.hidden)');
            cat.style.display = visibleBtns.length > 0 ? 'block' : 'none';
          });
        }
      });
    }

    // ==================== ROLES ====================
    document.querySelectorAll('.role-btn[data-role]').forEach(btn => {
      btn.addEventListener('click', () => {
        // Actualizar UI
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Actualizar rol actual
        currentRole = btn.dataset.role;
        activeRoleDisplay.textContent = btn.textContent.trim();
        
        showToast(`Rol cambiado a: ${btn.textContent.trim()}`);
      });
    });

    // ==================== ACCIONES ====================
    document.querySelectorAll('.role-btn[data-action]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        
        if (action === 'clear') {
          messagesContainer.innerHTML = '';
          showToast('Chat limpiado');
        } else if (action === 'stats') {
          if (window.sandraAPI) {
            const result = await window.sandraAPI.getStats();
            if (result.success) {
              const stats = result.stats;
              addMessage(`ğŸ“Š EstadÃ­sticas del Sistema:\n\n- Roles Activos: ${stats.activeRoles}/${stats.totalRoles}\n- Agentes Activos: ${stats.activeAgents}\n- Conversaciones: ${stats.conversations || 0}\n- Deployments: ${stats.deployments || 0}`, 'assistant');
            }
          }
        } else if (action === 'validate') {
          showToast('Validando roles...');
          setTimeout(() => showToast('âœ… Todos los roles validados'), 2000);
        } else if (action === 'mcp') {
          // Abrir panel MCP
          document.getElementById('mcp-panel').style.display = 'block';
        }
      });
    });

    // ==================== ENVIAR MENSAJE ====================
    async function sendMessage(mode = 'text') {
      const message = messageInput.value.trim();
      if (!message) return;

      // Limpiar input
      messageInput.value = '';

      // Agregar mensaje del usuario
      addMessage(message, 'user');

      // Mostrar loading
      loading.classList.add('active');

      try {
        if (window.sandraAPI) {
          // Pasar el modo (text/voice/video) al backend
          const result = await window.sandraAPI.sendMessage(message, currentRole, mode);
          
          if (result.success) {
            addMessage(result.response, 'assistant');
          } else {
            addMessage('Error: ' + result.error, 'assistant');
          }
        } else {
          // Modo offline/demo
          setTimeout(() => {
            const responses = [
              'Entendido, estoy procesando tu solicitud...',
              'Excelente pregunta. DÃ©jame analizar eso...',
              'Perfecto, trabajando en ello...',
              'Interesante planteamiento. Te ayudarÃ© con eso...'
            ];
            addMessage(responses[Math.floor(Math.random() * responses.length)], 'assistant');
          }, 1000);
        }
      } catch (error) {
        console.error('Error al enviar mensaje:', error);
        addMessage('Error al procesar el mensaje', 'assistant');
      } finally {
        loading.classList.remove('active');
      }
    }

    // ==================== GRABACIÃ“N DE VOZ CON DEEPGRAM ====================
    async function toggleVoiceRecording() {
      if (!isRecording) {
        // INICIAR GRABACIÃ“N
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 44100
            } 
          });
          
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'audio/webm'
          });
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await processVoiceInput(audioBlob);
            
            // Detener el stream
            stream.getTracks().forEach(track => track.stop());
          };

          mediaRecorder.start(100); // Capturar cada 100ms
          isRecording = true;
          
          // Iniciar visualizador de audio
          const visualizerCanvas = document.getElementById('audio-visualizer');
          if (visualizerCanvas) {
            visualizerCanvas.style.display = 'block';
            
            // Crear visualizador
            if (!audioVisualizer) {
              // Cargar AudioVisualizer desde archivo
              const AudioVisualizer = function(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.canvasContext = this.canvas ? this.canvas.getContext('2d') : null;
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.bufferLength = 0;
                this.animationId = null;
                this.isVisualizing = false;
                
                this.startVisualization = async function(stream) {
                  try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 2048;
                    this.bufferLength = this.analyser.frequencyBinCount;
                    this.dataArray = new Uint8Array(this.bufferLength);
                    const source = this.audioContext.createMediaStreamSource(stream);
                    source.connect(this.analyser);
                    this.isVisualizing = true;
                    this.draw();
                    return { success: true };
                  } catch (error) {
                    return { success: false, error: error.message };
                  }
                };
                
                this.draw = function() {
                  if (!this.isVisualizing) return;
                  this.animationId = requestAnimationFrame(() => this.draw());
                  if (!this.analyser || !this.dataArray) return;
                  this.analyser.getByteTimeDomainData(this.dataArray);
                  const ctx = this.canvasContext;
                  const width = this.canvas.width;
                  const height = this.canvas.height;
                  ctx.fillStyle = 'rgba(15, 52, 96, 0.3)';
                  ctx.fillRect(0, 0, width, height);
                  ctx.lineWidth = 2;
                  ctx.strokeStyle = '#667eea';
                  ctx.beginPath();
                  const sliceWidth = width / this.bufferLength;
                  let x = 0;
                  for (let i = 0; i < this.bufferLength; i++) {
                    const v = this.dataArray[i] / 128.0;
                    const y = (v * height) / 2;
                    if (i === 0) { ctx.moveTo(x, y); } else { ctx.lineTo(x, y); }
                    x += sliceWidth;
                  }
                  ctx.lineTo(width, height / 2);
                  ctx.stroke();
                };
                
                this.stop = function() {
                  this.isVisualizing = false;
                  if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                  }
                  if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                  }
                  if (this.canvas && this.canvasContext) {
                    this.canvasContext.clearRect(0, 0, this.canvas.width, this.canvas.height);
                  }
                };
              };
              
              audioVisualizer = new AudioVisualizer('audio-visualizer');
            }
            
            audioVisualizer.startVisualization(stream);
          }
          
          // Actualizar UI
          voiceBtn.classList.add('recording');
          voiceBtn.textContent = 'â¹ï¸';
          recordingIndicator.classList.add('active');
          
          showToast('ğŸ¤ Grabando... Click para detener');
        } catch (error) {
          console.error('Error al acceder al micrÃ³fono:', error);
          showToast('âŒ No se pudo acceder al micrÃ³fono', 'error');
        }
      } else {
        // DETENER GRABACIÃ“N
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        
        // Detener visualizador
        if (audioVisualizer) {
          audioVisualizer.stop();
          const visualizerCanvas = document.getElementById('audio-visualizer');
          if (visualizerCanvas) {
            visualizerCanvas.style.display = 'none';
          }
        }
        
        isRecording = false;
        
        // Restaurar UI
        voiceBtn.classList.remove('recording');
        voiceBtn.textContent = 'ğŸ¤';
        recordingIndicator.classList.remove('active');
        
        showToast('Procesando audio con Deepgram...');
      }
    }

    async function processVoiceInput(audioBlob) {
      try {
        if (!window.sandraAPI) {
          showToast('âŒ API no disponible', 'error');
          return;
        }

        showToast('ğŸ¤ Transcribiendo con Deepgram STT...');
        
        // Convertir blob a buffer
        const arrayBuffer = await audioBlob.arrayBuffer();
        const buffer = new Uint8Array(arrayBuffer);
        
        // Transcribir con Deepgram
        const result = await window.sandraAPI.transcribeBuffer(buffer, 'audio/webm');
        
        if (result.success) {
          messageInput.value = result.transcript;
          showToast(`âœ… Transcrito (${Math.round(result.confidence * 100)}% confianza)`);
          
          // Auto-enviar si hay texto (modo voz)
          if (result.transcript && result.transcript.trim().length > 0) {
            setTimeout(() => sendMessage('voice'), 500);
          }
        } else {
          showToast('âŒ Error en transcripciÃ³n: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Error al procesar audio:', error);
        showToast('âŒ Error al procesar el audio', 'error');
      }
    }

    // ==================== AGREGAR MENSAJE ====================
    function addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = sender === 'user' ? 'U' : 'S';
      
      const content = document.createElement('div');
      content.className = 'message-content';
      
      const textDiv = document.createElement('div');
      textDiv.textContent = text;
      
      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = new Date().toLocaleTimeString('es-ES');
      
      content.appendChild(textDiv);
      content.appendChild(time);
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);
      
      messagesContainer.appendChild(messageDiv);
      
      // SCROLL AUTOMÃTICO
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 100);
    }

    // ==================== TOAST ====================
    function showToast(message, type = 'success') {
      toastMessage.textContent = message;
      toast.className = `toast active ${type}`;
      
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // ==================== QUICK ACTIONS ====================
    async function executeQuickAction(action) {
      showToast(`ğŸš€ Ejecutando: ${action}...`);
      
      switch(action) {
        case 'system-status':
          addMessage('Verificando estado del sistema...', 'user');
          if (window.sandraAPI) {
            const status = await window.sandraAPI.getSystemStatus();
            if (status.success) {
              addMessage(`âœ… Estado del Sistema:\n\n${JSON.stringify(status.data, null, 2)}`, 'assistant');
            } else {
              addMessage('âš ï¸ No se pudo obtener el estado del sistema', 'assistant');
            }
          } else {
            addMessage('âœ… Sistema operativo\nâœ… 62 roles disponibles\nâœ… Multimodal activo', 'assistant');
          }
          break;
          
        case 'test-multimodal':
          addMessage('Probando sistema multimodal...', 'user');
          showToast('ğŸ¤ Iniciando prueba de voz...');
          // Simular prueba multimodal
          setTimeout(() => {
            addMessage('âœ… Sistema Multimodal:\nğŸ¤ Voz: Listo\nğŸ“¹ Avatar: Listo\nğŸ”„ Barge-in: Activado', 'assistant');
          }, 1000);
          break;
          
        case 'github-sync':
          addMessage('Sincronizando con GitHub...', 'user');
          if (window.sandraAPI) {
            const sync = await window.sandraAPI.syncWithGitHub();
            if (sync.success) {
              addMessage(`âœ… SincronizaciÃ³n completada:\n${sync.message}`, 'assistant');
            } else {
              addMessage(`âš ï¸ Error en sincronizaciÃ³n: ${sync.error}`, 'assistant');
            }
          } else {
            addMessage('âœ… Repositorio sincronizado\nâœ… 62 roles en GitHub', 'assistant');
          }
          break;
      }
    }

    // ==================== VIDEOCALL CON AVATAR ====================
    let isVideoCallActive = false;
    
    async function toggleVideoCall() {
      const videoBtn = document.getElementById('video-btn');
      const avatarPanel = document.querySelector('.avatar-panel');
      const avatarVideo = document.getElementById('heygen-avatar-video');
      
      if (!isVideoCallActive) {
        // INICIAR VIDEOCALL
        try {
          showToast('ğŸ“¹ Iniciando videollamada con avatar...');
          
          if (window.sandraAPI) {
            const result = await window.sandraAPI.startVideoCall();
            if (result.success) {
              isVideoCallActive = true;
              videoBtn.classList.add('active');
              avatarPanel.style.display = 'block';
              
              if (avatarVideo && result.stream) {
                avatarVideo.srcObject = result.stream;
                avatarVideo.style.display = 'block';
                avatarVideo.play();
              }
              
              showToast('âœ… Videollamada activa - Habla para interactuar');
              addMessage('ğŸ“¹ Videollamada iniciada. El avatar estÃ¡ listo para conversar.', 'assistant');
            } else {
              showToast('âŒ Error iniciando videollamada: ' + result.error, 'error');
            }
          } else {
            // Modo demo
            isVideoCallActive = true;
            videoBtn.classList.add('active');
            avatarPanel.style.display = 'block';
            showToast('âœ… Videollamada activa (modo demo)');
            addMessage('ğŸ“¹ Videollamada iniciada. El avatar estÃ¡ listo para conversar.', 'assistant');
          }
        } catch (error) {
          console.error('Error en videollamada:', error);
          showToast('âŒ Error: ' + error.message, 'error');
        }
      } else {
        // FINALIZAR VIDEOCALL
        try {
          if (window.sandraAPI) {
            await window.sandraAPI.stopVideoCall();
          }
          
          isVideoCallActive = false;
          videoBtn.classList.remove('active');
          
          if (avatarVideo) {
            avatarVideo.srcObject = null;
            avatarVideo.style.display = 'none';
          }
          
          showToast('ğŸ“¹ Videollamada finalizada');
          addMessage('ğŸ“¹ Videollamada finalizada.', 'assistant');
        } catch (error) {
          console.error('Error finalizando videollamada:', error);
        }
      }
    }

    // ==================== EVENT LISTENERS ====================
    sendBtn.addEventListener('click', sendMessage);
    voiceBtn.addEventListener('click', toggleVoiceRecording);
    document.getElementById('video-btn').addEventListener('click', toggleVideoCall);
    
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Prevenir que el input pierda foco al grabar
    voiceBtn.addEventListener('mousedown', (e) => {
      e.preventDefault();
    });

    // Selector de voz
    const voiceSelector = document.getElementById('voice-selector');
    if (voiceSelector) {
      voiceSelector.addEventListener('change', (e) => {
        currentVoiceId = e.target.value;
        showToast(`Voz cambiada a: ${e.target.options[e.target.selectedIndex].text}`);
      });
    }

    // Modo continuo
    const continuousModeToggle = document.getElementById('continuous-mode');
    if (continuousModeToggle) {
      continuousModeToggle.addEventListener('change', async (e) => {
        continuousMode = e.target.checked;
        
        if (continuousMode) {
          showToast('ğŸ”„ Modo continuo activado');
          if (window.sandraAPI) {
            await window.sandraAPI.startMultimodalConversation();
          }
        } else {
          showToast('Modo continuo desactivado');
          if (window.sandraAPI) {
            await window.sandraAPI.stopMultimodalConversation();
          }
        }
      });
    }

    // Barge-in toggle
    const bargeInToggle = document.getElementById('barge-in-toggle');
    if (bargeInToggle) {
      bargeInToggle.addEventListener('change', async (e) => {
        bargeInEnabled = e.target.checked;
        
        if (window.sandraAPI) {
          await window.sandraAPI.setBargeIn(bargeInEnabled);
        }
        
        showToast(`âš¡ Barge-in ${bargeInEnabled ? 'activado' : 'desactivado'}`);
      });
    }

    // ==================== HEYGEN AVATAR ====================
    async function initializeHeyGenAvatar() {
      const avatarContainer = document.getElementById('heygen-avatar');
      
      try {
        if (window.sandraAPI) {
          // Crear sesiÃ³n de avatar
          const result = await window.sandraAPI.createAvatarSession();
          
          if (result.success) {
            // AquÃ­ se integrarÃ­a el WebRTC stream del avatar
            avatarContainer.innerHTML = `
              <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div style="font-size: 60px;">ğŸ¤–</div>
                <div style="font-size: 14px; color: white; font-weight: 600;">Avatar Sandra</div>
                <div style="font-size: 11px; color: rgba(255,255,255,0.8);">âœ… SesiÃ³n Activa</div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.6);">ID: ${result.session.sessionId.substring(0, 8)}...</div>
              </div>
            `;
            
            showToast('âœ… Avatar HeyGen inicializado');
            avatarStatus.textContent = 'Streaming';
          } else {
            throw new Error(result.error);
          }
        }
      } catch (error) {
        console.error('Error inicializando avatar:', error);
        avatarContainer.innerHTML = `
          <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px;">
            <div style="font-size: 60px;">ğŸ¤–</div>
            <div style="font-size: 14px; color: rgba(255,255,255,0.6);">Avatar Sandra</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.4);">Modo Offline</div>
          </div>
        `;
      }
    }

    // ==================== EVENTOS MULTIMODALES ====================
    if (window.sandraAPI) {
      // ActualizaciÃ³n de transcripciÃ³n en tiempo real
      window.sandraAPI.onTranscriptUpdate((data) => {
        if (data.isFinal) {
          console.log('TranscripciÃ³n final:', data.transcript);
        } else {
          console.log('TranscripciÃ³n intermedia:', data.transcript);
        }
      });

      // Respuesta de IA lista
      window.sandraAPI.onResponseReady((data) => {
        console.log('Respuesta IA:', data.aiResponse);
        addMessage(data.aiResponse, 'assistant');
      });

      // Avatar hablando
      window.sandraAPI.onAvatarSpeaking((data) => {
        if (data.speaking) {
          avatarStatus.textContent = 'Hablando...';
          console.log('Avatar hablando:', data.text);
        } else {
          avatarStatus.textContent = 'Escuchando';
        }
      });

      // Error multimodal
      window.sandraAPI.onMultimodalError((data) => {
        console.error('Error multimodal:', data.error);
        showToast('âŒ ' + data.error, 'error');
      });
    }

    // Inicializar avatar
    initializeHeyGenAvatar();

    console.log('âœ… Sandra IA 8.0 Pro - Sistema Multimodal Completo Cargado');
    console.log('ğŸ¤ Deepgram STT - Listo');
    console.log('ğŸ”Š Cartesia TTS - Listo');
    console.log('ğŸ¤– HeyGen Avatar - Listo');
    console.log('ğŸ”„ Barge-in - Activado');

    // ==================== MCP PANEL ====================
    
    // Cerrar panel MCP
    document.getElementById('mcp-close').addEventListener('click', () => {
      document.getElementById('mcp-panel').style.display = 'none';
    });

    // Tabs del MCP
    document.querySelectorAll('.mcp-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Actualizar tabs activos
        document.querySelectorAll('.mcp-tab').forEach(t => {
          t.style.background = 'rgba(255,255,255,0.05)';
          t.style.borderColor = 'rgba(255,255,255,0.1)';
        });
        tab.style.background = 'rgba(102, 126, 234, 0.3)';
        tab.style.borderColor = '#667eea';
        
        // Mostrar contenido correspondiente
        document.querySelectorAll('.mcp-tab-content').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(`mcp-tab-${tabName}`).style.display = 'block';
      });
    });

    // Generar CÃ³digo
    document.getElementById('mcp-generate-code').addEventListener('click', async () => {
      const task = document.getElementById('mcp-code-task').value.trim();
      const role = document.getElementById('mcp-code-role').value;
      const language = document.getElementById('mcp-code-lang').value;
      
      if (!task) {
        showToast('âŒ Por favor describe la tarea', 'error');
        return;
      }
      
      showToast('ğŸ’» Generando cÃ³digo...');
      
      try {
        if (window.sandraAPI) {
          const result = await window.sandraAPI.mcpGenerateCode(task, role, language);
          
          if (result.success) {
            document.getElementById('mcp-code-output').style.display = 'block';
            document.getElementById('mcp-code-result').textContent = result.result.code;
            showToast('âœ… CÃ³digo generado correctamente');
          } else {
            showToast('âŒ Error: ' + result.error, 'error');
          }
        }
      } catch (error) {
        console.error('Error generando cÃ³digo:', error);
        showToast('âŒ Error al generar cÃ³digo', 'error');
      }
    });

    // Deploy
    document.getElementById('mcp-deploy-btn').addEventListener('click', async () => {
      const name = document.getElementById('mcp-deploy-name').value.trim();
      const repo = document.getElementById('mcp-deploy-repo').value.trim();
      const provider = document.getElementById('mcp-deploy-provider').value;
      const environment = document.getElementById('mcp-deploy-env').value;
      
      if (!name || !repo) {
        showToast('âŒ Completa todos los campos', 'error');
        return;
      }
      
      showToast('ğŸš€ Iniciando despliegue...');
      
      try {
        if (window.sandraAPI) {
          const result = await window.sandraAPI.mcpDeploy({
            name,
            repoUrl: repo,
            provider,
            environment,
            path: `./temp/${name}`
          });
          
          if (result.success) {
            const output = document.getElementById('mcp-deploy-output');
            output.style.display = 'block';
            output.innerHTML = `
              âœ… Despliegue completado<br>
              ğŸ“¦ Proyecto: ${name}<br>
              ğŸŒ URL: ${result.result.url || 'Generando...'}<br>
              â±ï¸ Tiempo: ${new Date().toLocaleTimeString()}
            `;
            showToast('âœ… Despliegue exitoso');
          } else {
            showToast('âŒ Error: ' + result.error, 'error');
          }
        }
      } catch (error) {
        console.error('Error en despliegue:', error);
        showToast('âŒ Error al desplegar', 'error');
      }
    });

    // Spawn Agent
    document.getElementById('mcp-spawn-agent').addEventListener('click', async () => {
      const role = document.getElementById('mcp-agent-role').value;
      
      showToast('ğŸ¤– Creando agente...');
      
      try {
        if (window.sandraAPI) {
          const result = await window.sandraAPI.mcpSpawnAgent(role, {});
          
          if (result.success) {
            showToast(`âœ… Agente ${role} creado`);
            await updateAgentsList();
          } else {
            showToast('âŒ Error: ' + result.error, 'error');
          }
        }
      } catch (error) {
        console.error('Error creando agente:', error);
        showToast('âŒ Error al crear agente', 'error');
      }
    });

    async function updateAgentsList() {
      try {
        if (window.sandraAPI) {
          const result = await window.sandraAPI.mcpGetAgents();
          
          if (result.success && result.agents.length > 0) {
            const listHtml = result.agents.map(agent => `
              <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #10b981;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-weight: 600; margin-bottom: 5px;">${agent.role}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.5);">ID: ${agent.id}</div>
                  </div>
                  <div style="padding: 4px 12px; background: rgba(16, 185, 129, 0.2); border-radius: 12px; font-size: 11px; color: #10b981;">
                    ${agent.status}
                  </div>
                </div>
                <div style="margin-top: 8px; font-size: 11px; color: rgba(255,255,255,0.6);">
                  Tareas completadas: ${agent.tasksCompleted || 0}
                </div>
              </div>
            `).join('');
            
            document.getElementById('mcp-agents-list').innerHTML = listHtml;
          } else {
            document.getElementById('mcp-agents-list').innerHTML = `
              <div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px 0;">
                No hay agentes activos
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error actualizando lista de agentes:', error);
      }
    }

    // GitHub Sync
    document.getElementById('mcp-github-sync').addEventListener('click', async () => {
      showToast('ğŸ”„ Sincronizando con GitHub...');
      
      try {
        if (window.sandraAPI) {
          const result = await window.sandraAPI.mcpSyncGitHub();
          
          if (result.success) {
            const status = result.result;
            const statusHtml = `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px;">
                  <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">Ãšltimo Commit</div>
                  <div style="font-weight: 600; font-size: 13px;">${status.lastCommit ? status.lastCommit.sha.substring(0, 7) : 'N/A'}</div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">${status.lastCommit ? status.lastCommit.commit.message.substring(0, 50) : ''}</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px;">
                  <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">Branch</div>
                  <div style="font-weight: 600; font-size: 13px;">${status.branch || 'main'}</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px;">
                  <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">â­ Stars</div>
                  <div style="font-weight: 600; font-size: 13px;">${status.stars || 0}</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 6px;">
                  <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">ğŸ”€ Forks</div>
                  <div style="font-weight: 600; font-size: 13px;">${status.forks || 0}</div>
                </div>
              </div>
            `;
            
            document.getElementById('mcp-github-status').innerHTML = statusHtml;
            showToast('âœ… SincronizaciÃ³n completada');
          } else {
            showToast('âŒ Error: ' + result.error, 'error');
          }
        }
      } catch (error) {
        console.error('Error sincronizando con GitHub:', error);
        showToast('âŒ Error al sincronizar', 'error');
      }
    });

    console.log('ğŸ› ï¸ MCP Panel - Listo');
  </script>
</body>
</html>
