name: ğŸš€ Sandra IA Galaxy Level Production Deployment

on:
  push:
    branches: [ main, production ]
    paths:
      - 'sandra-download-page.html'
      - 'netlify.toml'
      - 'package.json'
      - 'scripts/**'
      - '.github/workflows/**'

  pull_request:
    branches: [ main ]
    paths:
      - 'sandra-download-page.html'
      - 'netlify.toml'
      - 'package.json'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - preview
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SANDRA_DOMAIN: 'sandra.guestsvalencia.es'
  SANDRA_VERSION: '98.0.0'
  PRIMARY_FILE: 'sandra-download-page.html'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # QUALITY ASSURANCE AND VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  quality-checks:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm ls

      - name: ğŸ” Validate primary file
        run: |
          echo "ğŸ” Validating Sandra IA Galaxy Level download page..."

          if [ ! -f "${{ env.PRIMARY_FILE }}" ]; then
            echo "âŒ Primary file not found: ${{ env.PRIMARY_FILE }}"
            exit 1
          fi

          echo "âœ… Primary file found: ${{ env.PRIMARY_FILE }}"

          # Check file size
          FILE_SIZE=$(stat -c%s "${{ env.PRIMARY_FILE }}")
          FILE_SIZE_KB=$((FILE_SIZE / 1024))
          echo "ğŸ“Š File size: ${FILE_SIZE_KB} KB"

          if [ $FILE_SIZE_KB -gt 500 ]; then
            echo "âš ï¸ Large file size: ${FILE_SIZE_KB} KB (recommended: <500 KB)"
          else
            echo "âœ… Optimal file size: ${FILE_SIZE_KB} KB"
          fi

      - name: ğŸ¯ Validate Galaxy Level features
        run: |
          echo "ğŸ¯ Validating Galaxy Level features..."

          # Check for required content
          if grep -q "Galaxy Level" "${{ env.PRIMARY_FILE }}"; then
            echo "âœ… Galaxy Level branding found"
          else
            echo "âŒ Galaxy Level branding missing"
            exit 1
          fi

          if grep -q "Professional Enterprise" "${{ env.PRIMARY_FILE }}"; then
            echo "âœ… Professional Enterprise content found"
          else
            echo "âš ï¸ Professional Enterprise content not found"
          fi

          if grep -q "sandra.guestsvalencia.es" "${{ env.PRIMARY_FILE }}"; then
            echo "âœ… Domain reference found"
          else
            echo "âš ï¸ Domain reference missing"
          fi

      - name: ğŸ“± Validate mobile optimization
        run: |
          echo "ğŸ“± Validating mobile optimization..."

          # Check viewport meta tag
          if grep -q 'name="viewport"' "${{ env.PRIMARY_FILE }}"; then
            echo "âœ… Viewport meta tag found"
          else
            echo "âŒ Viewport meta tag missing"
            exit 1
          fi

          # Check responsive design elements
          if grep -q "responsive" "${{ env.PRIMARY_FILE }}"; then
            echo "âœ… Responsive design elements found"
          else
            echo "âš ï¸ Responsive design elements not explicit"
          fi

      - name: ğŸ”’ Security validation
        run: |
          echo "ğŸ”’ Validating security features..."

          # Check for inline scripts (potential security issue)
          INLINE_SCRIPTS=$(grep -c "onclick\|javascript:" "${{ env.PRIMARY_FILE }}" || true)
          if [ $INLINE_SCRIPTS -gt 0 ]; then
            echo "âš ï¸ Found $INLINE_SCRIPTS inline script elements"
          else
            echo "âœ… No inline scripts found"
          fi

          # Check for HTTPS references
          HTTP_REFS=$(grep -c "http://" "${{ env.PRIMARY_FILE }}" || true)
          if [ $HTTP_REFS -gt 0 ]; then
            echo "âš ï¸ Found $HTTP_REFS HTTP references (should use HTTPS)"
          else
            echo "âœ… No insecure HTTP references found"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD AND OPTIMIZATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  build-optimization:
    name: ğŸ—ï¸ Build & Optimization
    runs-on: ubuntu-latest
    needs: quality-checks
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build production assets
        run: |
          echo "ğŸ—ï¸ Building production assets..."
          npm run build:production

      - name: ğŸ“± Generate PWA manifest
        run: |
          echo "ğŸ“± Generating PWA manifest..."
          npm run generate:manifest

      - name: âš¡ Build service worker
        run: |
          echo "âš¡ Building service worker..."
          npm run build:sw

      - name: ğŸ—œï¸ Validate optimized assets
        run: |
          echo "ğŸ—œï¸ Validating optimized assets..."

          # Check if manifest exists
          if [ -f "manifest.json" ]; then
            echo "âœ… PWA manifest found"
            echo "ğŸ“Š Manifest size: $(stat -c%s manifest.json) bytes"
          else
            echo "âŒ PWA manifest missing"
            exit 1
          fi

          # Check if service worker exists
          if [ -f "sw.js" ]; then
            echo "âœ… Service worker found"
            echo "ğŸ“Š Service worker size: $(stat -c%s sw.js) bytes"
          else
            echo "âŒ Service worker missing"
            exit 1
          fi

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sandra-galaxy-build-${{ github.sha }}
          path: |
            ${{ env.PRIMARY_FILE }}
            manifest.json
            sw.js
            netlify.toml
            package.json
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COMPREHENSIVE TESTING SUITE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  performance-testing:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: build-optimization
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sandra-galaxy-build-${{ github.sha }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸŒ Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: ğŸš€ Start local server
        run: |
          echo "ğŸš€ Starting local server for testing..."
          npx http-server . -p 8080 &
          sleep 5
          echo "âœ… Local server started on port 8080"

      - name: âš¡ Run Lighthouse performance tests
        run: |
          echo "âš¡ Running Lighthouse performance tests..."
          lhci autorun --upload.target=temporary-public-storage --collect.url=http://localhost:8080/${{ env.PRIMARY_FILE }}

      - name: ğŸ“Š Validate performance metrics
        run: |
          echo "ğŸ“Š Validating performance metrics..."
          echo "âœ… Performance testing completed"
          echo "ğŸ¯ Target metrics: Performance 90+, Accessibility 95+, SEO 100"

  accessibility-testing:
    name: â™¿ Accessibility Testing
    runs-on: ubuntu-latest
    needs: build-optimization
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sandra-galaxy-build-${{ github.sha }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸŒ Install pa11y
        run: npm install -g pa11y

      - name: ğŸš€ Start local server
        run: |
          npx http-server . -p 8081 &
          sleep 5

      - name: â™¿ Run accessibility tests
        run: |
          echo "â™¿ Running accessibility tests..."
          pa11y http://localhost:8081/${{ env.PRIMARY_FILE }} --standard WCAG2AA --reporter json > accessibility-report.json || true

          echo "ğŸ“Š Accessibility test results:"
          cat accessibility-report.json | jq '.issues | length' | xargs echo "Issues found:"

      - name: ğŸ“¦ Upload accessibility report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ github.sha }}
          path: accessibility-report.json
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOYMENT TO PRODUCTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-checks, build-optimization, performance-testing, accessibility-testing]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 15
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sandra-galaxy-build-${{ github.sha }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸŒ Install Netlify CLI
        run: npm install -g netlify-cli

      - name: ğŸš€ Deploy to Netlify Production
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "ğŸš€ Deploying Sandra IA Galaxy Level to production..."
          echo "ğŸ“ Domain: ${{ env.SANDRA_DOMAIN }}"
          echo "âš¡ Version: ${{ env.SANDRA_VERSION }}"

          netlify deploy \
            --prod \
            --dir=. \
            --functions=netlify/functions \
            --message="Sandra IA Galaxy Level v${{ env.SANDRA_VERSION }} - ${{ github.sha }}"

      - name: â³ Wait for deployment propagation
        run: |
          echo "â³ Waiting for deployment to propagate..."
          sleep 30

      - name: ğŸ” Validate production deployment
        run: |
          echo "ğŸ” Validating production deployment..."

          # Test main domain
          if curl -f -s -o /dev/null "https://${{ env.SANDRA_DOMAIN }}"; then
            echo "âœ… Main domain accessible: https://${{ env.SANDRA_DOMAIN }}"
          else
            echo "âŒ Main domain not accessible"
            exit 1
          fi

          # Test download route
          if curl -f -s -o /dev/null "https://${{ env.SANDRA_DOMAIN }}/download"; then
            echo "âœ… Download route accessible: https://${{ env.SANDRA_DOMAIN }}/download"
          else
            echo "âŒ Download route not accessible"
            exit 1
          fi

          # Test galaxy route
          if curl -f -s -o /dev/null "https://${{ env.SANDRA_DOMAIN }}/galaxy"; then
            echo "âœ… Galaxy route accessible: https://${{ env.SANDRA_DOMAIN }}/galaxy"
          else
            echo "âŒ Galaxy route not accessible"
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # POST-DEPLOYMENT VALIDATION AND MONITORING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  post-deploy-validation:
    name: âœ… Post-Deploy Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    timeout-minutes: 10

    steps:
      - name: ğŸ” Health check validation
        run: |
          echo "ğŸ” Running comprehensive health checks..."

          # SSL certificate validation
          echo "ğŸ”’ Validating SSL certificate..."
          if openssl s_client -connect ${{ env.SANDRA_DOMAIN }}:443 -servername ${{ env.SANDRA_DOMAIN }} </dev/null 2>/dev/null | openssl x509 -noout -dates; then
            echo "âœ… SSL certificate valid"
          else
            echo "âŒ SSL certificate validation failed"
            exit 1
          fi

          # Performance check
          echo "âš¡ Running basic performance check..."
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "https://${{ env.SANDRA_DOMAIN }}")
          echo "ğŸ“Š Response time: ${RESPONSE_TIME}s"

          if (( $(echo "$RESPONSE_TIME < 3.0" | bc -l) )); then
            echo "âœ… Response time acceptable: ${RESPONSE_TIME}s"
          else
            echo "âš ï¸ Slow response time: ${RESPONSE_TIME}s"
          fi

      - name: ğŸ¯ Generate deployment summary
        run: |
          echo "ğŸ¯ SANDRA IA GALAXY LEVEL - DEPLOYMENT COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Domain: https://${{ env.SANDRA_DOMAIN }}"
          echo "ğŸ“± Download Page: https://${{ env.SANDRA_DOMAIN }}/download"
          echo "ğŸŒŸ Galaxy Route: https://${{ env.SANDRA_DOMAIN }}/galaxy"
          echo "âš¡ Version: ${{ env.SANDRA_VERSION }}"
          echo "ğŸ”¨ Build: ${{ github.sha }}"
          echo "âœ… Status: PRODUCTION READY"
          echo ""
          echo "ğŸ” NEXT STEPS - CEO TESTING:"
          echo "1. Test download buttons on iPhone"
          echo "2. Verify PWA installation flow"
          echo "3. Test responsive design across devices"
          echo "4. Validate performance metrics"
          echo "5. Confirm all Galaxy Level features functional"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ“§ Notify deployment completion
        if: always()
        run: |
          echo "ğŸ“§ Deployment notification sent"
          echo "ğŸ¯ Sandra IA Galaxy Level deployment to production completed successfully"