/**
 * FILESYSTEM EXECUTOR - Escritura real de archivos
 * Permite a Sandra escribir código y contenido realmente
 */

const fs = require('fs').promises;
const path = require('path');

class FileSystemExecutor {
    constructor() {
        this.basePath = 'C:\\Users\\clayt\\Desktop\\sandra-professional';
        this.allowedExtensions = ['.js', '.jsx', '.html', '.css', '.md', '.json', '.txt'];
    }

    // ============================================================================
    // ESCRIBIR CÓDIGO REAL
    // ============================================================================
    async writeCode(params, context) {
        try {
            const { filename, type, content } = params;

            if (!filename) {
                return { success: false, error: 'Nombre de archivo requerido' };
            }

            // Generar contenido según el tipo
            let codeContent = content;
            if (!codeContent) {
                codeContent = this.generateCodeTemplate(type, filename);
            }

            // Determinar ruta de destino
            const targetPath = this.getTargetPath(filename, type);

            // Escribir archivo
            await fs.writeFile(targetPath, codeContent, 'utf8');

            console.log(`✅ Archivo escrito: ${targetPath}`);

            return {
                success: true,
                message: `Archivo ${filename} creado exitosamente`,
                data: {
                    filename: filename,
                    path: targetPath,
                    size: codeContent.length,
                    type: type
                }
            };

        } catch (error) {
            console.error('❌ Error escribiendo código:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // ============================================================================
    // CREAR CONTENIDO (MARKETING/BLOG)
    // ============================================================================
    async createContent(params, context) {
        try {
            const { title, type = 'blog', content } = params;

            if (!title) {
                return { success: false, error: 'Título de contenido requerido' };
            }

            // Generar contenido de marketing
            const contentData = content || this.generateMarketingContent(title, type);

            // Crear nombre de archivo seguro
            const filename = this.sanitizeFilename(title) + '.md';
            const contentPath = path.join(this.basePath, 'content', filename);

            // Asegurar que el directorio existe
            await fs.mkdir(path.dirname(contentPath), { recursive: true });

            // Escribir contenido
            await fs.writeFile(contentPath, contentData, 'utf8');

            console.log(`✅ Contenido creado: ${contentPath}`);

            return {
                success: true,
                message: `Contenido "${title}" creado exitosamente`,
                data: {
                    title: title,
                    filename: filename,
                    path: contentPath,
                    type: type,
                    wordCount: contentData.split(' ').length
                }
            };

        } catch (error) {
            console.error('❌ Error creando contenido:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // ============================================================================
    // UTILIDADES
    // ============================================================================
    getTargetPath(filename, type) {
        let subdirectory = '';

        switch (type) {
            case 'react':
            case 'jsx':
                subdirectory = 'frontend/components';
                break;
            case 'nodejs':
            case 'server':
                subdirectory = 'backend';
                break;
            case 'html':
                subdirectory = 'frontend';
                break;
            default:
                subdirectory = 'generated';
        }

        return path.join(this.basePath, subdirectory, filename);
    }

    generateCodeTemplate(type, filename) {
        const templates = {
            react: `import React from 'react';

const ${this.getComponentName(filename)} = () => {
    return (
        <div className="${this.getComponentName(filename).toLowerCase()}">
            <h1>Generated by Sandra IA</h1>
            <p>Component created automatically</p>
        </div>
    );
};

export default ${this.getComponentName(filename)};`,

            nodejs: `/**
 * Generated by Sandra IA - GuestsValencia
 * Archivo: ${filename}
 */

const express = require('express');

class ${this.getComponentName(filename)} {
    constructor() {
        this.initialized = true;
    }

    async initialize() {
        console.log('✅ ${filename} inicializado por Sandra');
        return { success: true };
    }
}

module.exports = ${this.getComponentName(filename)};`,

            html: `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated by Sandra IA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .sandra-header { color: #2563eb; }
    </style>
</head>
<body>
    <h1 class="sandra-header">Página creada por Sandra IA</h1>
    <p>Archivo: ${filename}</p>
    <p>Generado automáticamente para GuestsValencia</p>
</body>
</html>`
        };

        return templates[type] || `// Generated by Sandra IA
// Archivo: ${filename}

console.log('✅ Código generado por Sandra para GuestsValencia');`;
    }

    generateMarketingContent(title, type) {
        const currentDate = new Date().toISOString().split('T')[0];

        return `---
title: "${title}"
date: ${currentDate}
author: Sandra IA
category: ${type}
tags: [valencia, turismo, guestsvalencia]
---

# ${title}

> Contenido generado automáticamente por Sandra IA para GuestsValencia

## Introducción

Este contenido ha sido creado como parte de la estrategia digital de GuestsValencia, enfocándose en la promoción de nuestros alojamientos premium en Valencia.

## Puntos Clave

- **Experiencia Premium**: Alojamientos de lujo en Valencia
- **Ubicación Estratégica**: Cerca de las principales atracciones
- **Servicio Personalizado**: Atención 24/7 con Sandra IA

## Llamada a la Acción

¿Listo para vivir Valencia como nunca antes? Reserva ahora en GuestsValencia y descubre la diferencia.

---
*Contenido creado por Sandra IA - Sistema Ejecutable v100.0*`;
    }

    getComponentName(filename) {
        // Convertir filename a PascalCase para componentes
        return filename
            .replace(/\.[^/.]+$/, '') // Remover extensión
            .split(/[-_]/)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join('');
    }

    sanitizeFilename(title) {
        return title
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .substring(0, 50);
    }

    // ============================================================================
    // VALIDACIÓN DE SEGURIDAD
    // ============================================================================
    isAllowedPath(targetPath) {
        const normalizedPath = path.normalize(targetPath);
        const normalizedBase = path.normalize(this.basePath);

        return normalizedPath.startsWith(normalizedBase);
    }

    isAllowedExtension(filename) {
        const ext = path.extname(filename).toLowerCase();
        return this.allowedExtensions.includes(ext);
    }
}

module.exports = FileSystemExecutor;