<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sandra IA - Socket.IO Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #ffffff;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }

    .status-bar {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
    }

    .status-item {
      text-align: center;
    }

    .status-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 18px;
      font-weight: bold;
    }

    .status-value.connected {
      color: #00ff88;
    }

    .status-value.disconnected {
      color: #ff4444;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    button {
      padding: 15px 25px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #00ff88 0%, #00aa55 100%);
      color: #0a0a0a;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    button.danger {
      background: linear-gradient(135deg, #ff4444 0%, #aa0000 100%);
      color: #ffffff;
    }

    .message-input {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid rgba(0, 255, 136, 0.3);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      margin-bottom: 20px;
    }

    .message-input:focus {
      outline: none;
      border-color: #00ff88;
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }

    .log-container {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .log-entry {
      padding: 8px;
      margin-bottom: 5px;
      border-left: 3px solid #00ff88;
      padding-left: 15px;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .log-entry.error {
      border-color: #ff4444;
      color: #ff4444;
    }

    .log-entry.success {
      border-color: #00ff88;
      color: #00ff88;
    }

    .log-entry.info {
      border-color: #4488ff;
      color: #4488ff;
    }

    .timestamp {
      opacity: 0.5;
      font-size: 12px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sandra IA - Socket.IO Test Console</h1>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <div class="status-label">Connection</div>
        <div class="status-value disconnected" id="statusConnection">Disconnected</div>
      </div>
      <div class="status-item">
        <div class="status-label">Authentication</div>
        <div class="status-value disconnected" id="statusAuth">Not Authenticated</div>
      </div>
      <div class="status-item">
        <div class="status-label">Call Status</div>
        <div class="status-value disconnected" id="statusCall">Inactive</div>
      </div>
      <div class="status-item">
        <div class="status-label">Latency</div>
        <div class="status-value" id="statusLatency">-- ms</div>
      </div>
      <div class="status-item">
        <div class="status-label">Messages Sent</div>
        <div class="status-value" id="statusMsgSent">0</div>
      </div>
      <div class="status-item">
        <div class="status-label">Messages Received</div>
        <div class="status-value" id="statusMsgReceived">0</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
      <button id="btnStartCall" disabled>Start Call</button>
      <button id="btnEndCall" disabled>End Call</button>
      <button id="btnBargeIn" disabled>Trigger Barge-In</button>
      <button id="btnClearLog" class="danger">Clear Log</button>
    </div>

    <!-- Message Input -->
    <input
      type="text"
      class="message-input"
      id="messageInput"
      placeholder="Type a message to send to Sandra..."
      disabled
    >

    <!-- Log -->
    <div class="log-container" id="logContainer"></div>
  </div>

  <!-- Socket.IO Client Library -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <!-- Sandra IA Modules -->
  <script src="/js/socket-client.js"></script>

  <!-- Test Script -->
  <script>
    let socketClient = null;
    let messageCount = { sent: 0, received: 0 };

    // UI Elements
    const elements = {
      btnConnect: document.getElementById('btnConnect'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      btnStartCall: document.getElementById('btnStartCall'),
      btnEndCall: document.getElementById('btnEndCall'),
      btnBargeIn: document.getElementById('btnBargeIn'),
      btnClearLog: document.getElementById('btnClearLog'),
      messageInput: document.getElementById('messageInput'),
      logContainer: document.getElementById('logContainer'),
      statusConnection: document.getElementById('statusConnection'),
      statusAuth: document.getElementById('statusAuth'),
      statusCall: document.getElementById('statusCall'),
      statusLatency: document.getElementById('statusLatency'),
      statusMsgSent: document.getElementById('statusMsgSent'),
      statusMsgReceived: document.getElementById('statusMsgReceived')
    };

    // Initialize
    function initialize() {
      log('ðŸš€ Initializing Socket.IO test console...', 'info');

      socketClient = new SocketClient({
        serverUrl: window.location.origin,
        namespace: '/sandra',
        autoConnect: false
      });

      setupSocketHandlers();
      setupUIHandlers();

      log('âœ… Test console ready', 'success');
    }

    // Setup Socket Handlers
    function setupSocketHandlers() {
      socketClient.onConnected = () => {
        log('âœ… Socket connected', 'success');
        updateStatus('connection', 'connected', 'Connected');
        elements.btnConnect.disabled = true;
        elements.btnDisconnect.disabled = false;
      };

      socketClient.onDisconnected = (reason) => {
        log(`ðŸ”Œ Socket disconnected: ${reason}`, 'error');
        updateStatus('connection', 'disconnected', 'Disconnected');
        elements.btnConnect.disabled = false;
        elements.btnDisconnect.disabled = true;
        elements.btnStartCall.disabled = true;
        elements.btnEndCall.disabled = true;
        elements.messageInput.disabled = true;
      };

      socketClient.onAuthenticated = (data) => {
        log(`âœ… Authenticated as: ${data.userId}`, 'success');
        updateStatus('auth', 'connected', 'Authenticated');
        elements.btnStartCall.disabled = false;
        elements.messageInput.disabled = false;
      };

      socketClient.onCallStarted = (data) => {
        log('ðŸ“ž Call started', 'success');
        updateStatus('call', 'connected', 'Active');
        elements.btnStartCall.disabled = true;
        elements.btnEndCall.disabled = false;
        elements.btnBargeIn.disabled = false;
      };

      socketClient.onCallEnded = (data) => {
        log(`ðŸ“ž Call ended (duration: ${data.duration}ms)`, 'info');
        updateStatus('call', 'disconnected', 'Inactive');
        elements.btnStartCall.disabled = false;
        elements.btnEndCall.disabled = true;
        elements.btnBargeIn.disabled = true;
      };

      socketClient.onSandraResponse = (data) => {
        log(`ðŸ’¬ Sandra: ${data.message}`, 'success');
        messageCount.received++;
        updateMessageCount();
      };

      socketClient.onSandraTyping = (data) => {
        if (data.isTyping) {
          log('âœï¸ Sandra is typing...', 'info');
        }
      };

      socketClient.onSandraAudioStart = () => {
        log('ðŸ”Š Sandra audio started', 'info');
      };

      socketClient.onSandraAudioChunk = (data) => {
        // Audio chunk received (don't log every chunk)
      };

      socketClient.onSandraAudioEnd = () => {
        log('ðŸ”Š Sandra audio ended', 'info');
      };

      socketClient.onBargeInAck = () => {
        log('âœ… Barge-in acknowledged', 'success');
      };

      socketClient.onError = (error) => {
        log(`âŒ Error: ${error.message || error}`, 'error');
      };
    }

    // Setup UI Handlers
    function setupUIHandlers() {
      elements.btnConnect.addEventListener('click', () => {
        log('ðŸ”Œ Connecting to Socket.IO server...', 'info');
        socketClient.connect();
        setTimeout(() => {
          if (socketClient.isConnected()) {
            socketClient.authenticate('sandrita-test');
          }
        }, 1000);
      });

      elements.btnDisconnect.addEventListener('click', () => {
        log('ðŸ”Œ Disconnecting...', 'info');
        socketClient.disconnect();
      });

      elements.btnStartCall.addEventListener('click', () => {
        log('ðŸ“ž Starting call...', 'info');
        socketClient.startCall();
      });

      elements.btnEndCall.addEventListener('click', () => {
        log('ðŸ“ž Ending call...', 'info');
        socketClient.endCall();
      });

      elements.btnBargeIn.addEventListener('click', () => {
        log('ðŸ›‘ Triggering barge-in...', 'info');
        socketClient.triggerBargeIn();
      });

      elements.btnClearLog.addEventListener('click', () => {
        elements.logContainer.innerHTML = '';
        messageCount = { sent: 0, received: 0 };
        updateMessageCount();
      });

      elements.messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && elements.messageInput.value.trim()) {
          const message = elements.messageInput.value.trim();
          log(`ðŸ’¬ You: ${message}`, 'info');
          socketClient.sendMessage(message);
          messageCount.sent++;
          updateMessageCount();
          elements.messageInput.value = '';
        }
      });

      // Ping interval
      setInterval(() => {
        if (socketClient && socketClient.isConnected()) {
          socketClient.ping();
          setTimeout(() => {
            const latency = socketClient.getLatency();
            elements.statusLatency.textContent = `${latency} ms`;
          }, 100);
        }
      }, 5000);
    }

    // Logging
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;

      const timestamp = new Date().toLocaleTimeString('es-ES', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        fractionalSecondDigits: 3
      });

      entry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
      elements.logContainer.appendChild(entry);
      elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
    }

    // Update Status
    function updateStatus(type, status, text) {
      const element = elements[`status${type.charAt(0).toUpperCase() + type.slice(1)}`];
      element.className = `status-value ${status}`;
      element.textContent = text;
    }

    // Update Message Count
    function updateMessageCount() {
      elements.statusMsgSent.textContent = messageCount.sent;
      elements.statusMsgReceived.textContent = messageCount.received;
    }

    // Initialize on load
    initialize();
  </script>
</body>
</html>
